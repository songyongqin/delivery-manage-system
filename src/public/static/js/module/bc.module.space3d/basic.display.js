requirejs.config({baseUrl:"./js",paths:{jquery:"libs/jquery-2.0.2",tween:"libs/Tween",three:"libs/three",raycaster:"libs/Raycaster",octree:"libs/Octree"},shim:{three:{exports:"THREE"},raycaster:{deps:["three"],exports:"THREE.Raycaster"},octree:{deps:["three"],exports:"THREE.Octree"}}});define(["jquery","tween","three","raycaster","octree"],function(){THREE.Points=function(e,t,r){THREE.Object3D.call(this);this.type="Points";this.geometry=e!==undefined?e:new THREE.Geometry;this.material=t!==undefined?t:new THREE.PointsMaterial({color:Math.random()*16777215});this.raycaster_threshold=r!==undefined?r:1};THREE.Points.prototype=Object.create(THREE.Object3D.prototype);THREE.Points.prototype.constructor=THREE.Points;THREE.Points.prototype.raycast=function(){var e=new THREE.Matrix4;var t=new THREE.Ray;return function r(a,i){var n=this;var o=n.geometry;var s=n.raycaster_threshold;e.getInverse(this.matrixWorld);t.copy(a.ray).applyMatrix4(e);if(o.boundingBox!==null){if(t.isIntersectionBox(o.boundingBox)===false){return}}var d=s/((this.scale.x+this.scale.y+this.scale.z)/3);var c=d*d;var u=new THREE.Vector3;function l(e,r){var o=t.distanceSqToPoint(e);if(o<c){var s=t.closestPointToPoint(e);s.applyMatrix4(n.matrixWorld);var d=a.ray.origin.distanceTo(s);if(d<a.near||d>a.far)return;i.push({distance:d,distanceToRay:Math.sqrt(o),point:s.clone(),index:r,face:null,object:n})}}if(o instanceof THREE.BufferGeometry){var f=o.index;var v=o.attributes;var h=v.position.array;var p=v.customOpacity.array;var E=v.customSize.array;if(f!==null){var m=f.array;for(var y=0,g=m.length;y<g;y++){var w=m[y];u.fromArray(h,w*3);l(u,w)}}else{for(var y=0,T=h.length/3;y<T;y++){if(p[y]==0||E[y]==0){continue}else{u.fromArray(h,y*3);l(u,y)}}}}else{var R=o.vertices;for(var y=0,T=R.length;y<T;y++){l(R[y],y)}}}}();THREE.Points.prototype.clone=function(){return new this.constructor(this.geometry,this.material,this.raycaster_threshold).copy(this)};function e(e){var t;var r,a;var i;var n=e.texturesRoot;var o=e.textureslibs;var s=e.texturesSize;var d=e.texturesWord;var c=M();var u=e.animate;var l=e.zoomupdate;var f=[];var v=false;var h=false;document.onkeydown=function(e){var e=e||window.event||arguments.callee.arguments[0];if(e&&e.keyCode==16){h=!h}};var p={nodeSystem:{vertexShader:["uniform float size;","uniform float pixelRatio;","attribute vec3 customColor;","attribute float customOpacity;","attribute float customSize;","varying float opa;","varying vec3 vColor;","void main(){","vColor = customColor;","opa = customOpacity;","vec4 mvPosition = modelViewMatrix * vec4(position,1.0);","float ratio;","if(pixelRatio > 1.25){","ratio = pow(pixelRatio,0.45);","gl_PointSize = customSize * size * ( 400.0 / length(mvPosition.xyz)) / ratio;","} else {","ratio = pow(pixelRatio,0.5);","gl_PointSize = customSize * size * ( 400.0 / length(mvPosition.xyz)) * ratio;","}","gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),fragmentShader:["uniform vec3 color;","uniform sampler2D texture;","uniform float opacity;","varying vec3 vColor;","varying float opa;","void main(){","vec4 outColor = texture2D(texture,vec2(gl_PointCoord.x,1.0 - gl_PointCoord.y));","if(outColor.a < 0.1) discard;","vec3 FragColor = vColor * vec3(outColor.rgb);","gl_FragColor = vec4(FragColor,opacity * opa * outColor.a);","}"].join("\n")}};var E=function(){r=e.topoDivId!==undefined?document.getElementById(e.topoDivId):document.body;t=new THREE.WebGLRenderer({antialias:true,alpha:true});var n=e.themeConfig.render_color!==undefined?e.themeConfig.render_color:8768;t.setSize($(r).width(),$(r).height());t.resize=function(){t.setSize($(r).width(),$(r).height())};r.appendChild(t.domElement);a=e.topoControlsDivId!==undefined?document.getElementById(e.topoControlsDivId):r;i=document.createElement("div");i.style.zIndex=a.style.zIndex-1;i.id="boxDivContainer";i.style.position="absolute";i.style.border="1px dotted white";i.style.borderRadius="5px";a.appendChild(i);var o=e.themeConfig.fogColor!==undefined?e.themeConfig.fog_color:8768;var s=e.themeConfig.fogNear!==undefined?e.themeConfig.fog_near:1;var d=e.themeConfig.fogFar!==undefined?e.themeConfig.fog_far:5e4;var l=new THREE.Scene;l.fog=new THREE.Fog(o,s,d);var v=e.topoS;var h=new THREE.Object3D;l.add(h);var p=e.themeConfig.camera_fov!==undefined?e.themeConfig.camera_fov:60;var E=e.themeConfig.camera_near!==undefined?e.themeConfig.camera_near:1;var H=e.themeConfig.camera_far!==undefined?e.themeConfig.camera_far:1e5;var C=b({fov:p,near:E,far:H});var M=new x(C,a);M.maxDistance=25e3;M.resize=function(){a.style.width=$(a).width();a.style.height=$(a).height()};M.update();var S=new THREE.Octree({undeferred:false,depthMax:Infinity,objectsThreshold:8,overlapPct:.15});var z=_(h,v,S);var P=v.view_angle;if(P){C.posRedefine({cameraPos:P.cameraPos,targetPos:P.targetPos})}var I;if(e.themeConfig.enableRay){I=g(a,S,C,z);if(e.themeConfig.nodeRayScale){w(z,v);T(I,z)}R(I,l,C)}else{console.info("stop ray")}L();onWindowResize=y.bind(this,C,M,z.pointsSystemDict);e.themeConfig.topoResize&&window.addEventListener("resize",onWindowResize,false);var V={enableVisual:true,left:0,bottom:0,width:$(r).width(),height:$(r).height(),scene:l,camera:C,background:new THREE.Color(n),alpha:1,left_ratio:0,bottom_ratio:0,width_ratio:1,height_ratio:1};f.push(V);if(e.themeConfig.viewports){for(var D in e.themeConfig.viewports){var j=e.themeConfig.viewports[D];var V=m(j);f.push(V)}}var k=function(e){var t=e.topoS;var i=new THREE.Object3D;i.name=t.name;l.add(i);var n=_(i,t,S);var o={camera:C,controls:M,stage:i,scene:l,nodeIdDict:n.nodeIdDict,topo_node_line:n.topo_node_line,pointsSystemDict:n.pointsSystemDict,octree:S,TWEEN:TWEEN,container:r,controlsContainer:a,onWindowResize:onWindowResize,viewsLibrary:f,data_structure:t};return o};var Y={camera:C,controls:M,stage:h,scene:l,rayFunc:I,nodeIdDict:z.nodeIdDict,topo_node_line:z.topo_node_line,pointsSystemDict:z.pointsSystemDict,octree:S,TWEEN:TWEEN,texturesLibrary:c,container:r,controlsContainer:a,onWindowResize:onWindowResize,viewsLibrary:f,data_structure:v,createStage:k};return Y;function L(){for(var e=0;e<f.length;e++){if(f[e].enableVisual){t.setViewport(f[e].left,f[e].bottom,f[e].width,f[e].height);t.setScissor(f[e].left,f[e].bottom,f[e].width,f[e].height);t.enableScissorTest(true);t.setClearColor(f[e].background,f[e].alpha);t.render(f[e].scene,f[e].camera)}}TWEEN.update();if(typeof u=="function"){u()}requestAnimationFrame(L)}};function m(e){var t={};t.enableVisual=e.enableVisual!==undefined?e.enableVisual:false;var a=e.left!==undefined?e.left:0;var i=e.bottom!==undefined?e.bottom:0;var n=e.width!==undefined?e.width:.1;var o=e.height!==undefined?e.height:.1;t.left_ratio=a;t.bottom_ratio=i;t.width_ratio=n;t.height_ratio=o;t.left=a*$(r).width();t.bottom=i*$(r).height();t.width=n*$(r).width();t.height=n*$(r).height();var s=e.camera_fov!==undefined?e.camera_fov:60;var d=e.camera_near!==undefined?e.camera_near:1;var c=e.camera_far!==undefined?e.camera_far:1e4;t.camera=b({fov:s,near:d,far:c});t.camera.updateProjectionMatrix();t.scene=new THREE.Scene;t.background=new THREE.Color(e.background);t.alpha=e.alpha!==undefined?e.alpha:1;return t}function y(e,a,i){for(var n in i){if(n!=="line"){i[n].material.uniforms.pixelRatio.value=$(r).width()/$(r).height()}}var o=$(r).width();var s=$(r).height();for(var d=0;d<f.length;d++){var c=f[d];c.width=c.width_ratio*o;c.height=c.height_ratio*s;c.left=c.left_ratio*o;c.bottom=c.bottom_ratio*s}e.resize();t.resize();a.resize()}function g(t,r,a,n){var o=new THREE.Vector2;var s,d;var c=new THREE.Raycaster;var u,l,f,h;var p=false;var E=new Array;var m=new Array;var y,g,w,T;var R,b,x,H;t.addEventListener("mousedown",function(){var e=event;C(e)},false);function C(e){if(e.ctrlKey){u=e.clientX;l=e.clientY;p=true;E=n.getAllPosition(a)}t.addEventListener("mousemove",M,false);t.addEventListener("mouseup",S,false)}function M(e){if(p&&e.ctrlKey){i.style.top=Math.min(e.clientY,l)+"px";i.style.left=Math.min(e.clientX,u)+"px";i.style.width=Math.abs(e.clientX-u)+"px";i.style.height=Math.abs(e.clientY-l)+"px"}}function S(e){t.removeEventListener("mousemove",M,false);t.removeEventListener("mouseup",S,false);if(e.ctrlKey){i.style.width="0px";i.style.height="0px";p=false;i.style.top="0px";i.style.left="0px";f=e.clientX;h=e.clientY;var r=$(t).width()/2;var a=$(t).height()/2;y=(u-r)/r;w=-(l-a)/a;g=(f-r)/r;T=-(h-a)/a;R=Math.min(y,g);b=Math.min(w,T);x=Math.max(y,g);H=Math.max(w,T);m=new Array;var n;for(var o=0;o<E.length;o++){n=E[o];if(n.x>=R&&n.x<=x&&n.y>=b&&n.y<=H){m.push(E[o])}}for(var o=0;o<m.length;o++){var s=onRayCompleteHandler(m[o],e)}if(typeof onRayMultiNode=="function"){onRayMultiNode(s,e)}}}clickTimeout={_timeout:null,set:function(e){var t=this;t.clear();t._timeout=window.setTimeout(e,300)},clear:function(){var e=this;if(e._timeout){window.clearTimeout(e._timeout)}}};var z=P;t.addEventListener("click",function(){var e=event;clickTimeout.set(function(){z(e)})},false);function P(e){if(v)return;var t=j(e);if(t!==undefined){if(t.object.nodeId!=undefined){d=t.object.nodeId}else{d=t.object.geometry.idsList[t.index]}}else{d=undefined}if(typeof onRayShowInfoHandler=="function"){var r=onRayShowInfoHandler(d,e)}var a=onRayCompleteHandler(t,e,r);if(typeof onRayMultiNode=="function"){onRayMultiNode(a,e)}}var I=_;t.addEventListener("dblclick",function(){var e=event;clickTimeout.clear();I(e)},false);function _(e){var t=j(e);if(t!==undefined){if(t.object.nodeId!=undefined){d=t.object.nodeId}else{d=t.object.geometry.idsList[t.index]}}else{d=undefined}if(typeof onRayShowInterHandler=="function"){var r=onRayShowInterHandler(d,e)}onRayCompleteHandler(t,e,r)}if(e.themeConfig.nodeRayScale){var V=D;t.addEventListener("mouseup",function(e){e.preventDefault();if(e.button===2){var t=e;V(t)}},false);function D(e){var t=j(e);onRayShrinkHandler(t,e)}}function j(e){e.preventDefault();var i=$(t).width();var n=$(t).height();o.x=e.clientX/i*2-1;o.y=-(e.clientY/n)*2+1;c.setFromCamera(o,a);r.rebuild();r.update();octreeObjects=r.search(c.ray.origin,c.ray.far,true,c.ray.direction);intersections=c.intersectOctreeObjects(octreeObjects);if(intersections.length>0){s=intersections[0];if(s.object instanceof THREE.Points){var d=s.index;if(s.object.geometry.attributes.customOpacity.array[d]==0){s=undefined}}}else{s=undefined}return s}var k={dispatch:function(e,t){switch(e){case"onRayComplete":onRayCompleteHandler=t;break;case"onRayShrink":onRayShrinkHandler=t;break;case"onRayShowInfo":onRayShowInfoHandler=t;break;case"onRayShowInter":onRayShowInterHandler=t;break;case"onRayMultiNode":onRayMultiNode=t}}};return k}function w(e,t){var r=t.json_data;var a=e.nodeIdDict;for(var i in r){var n=r[i]["level"];for(var o=0;o<n.length;o++){for(var s=0;s<n[o].length;s++){a[n[o][s]].level=o}}}for(var d in a){a[d].down=[];for(var c=0;c<a[d].links.length;c++){if(a[d].level<a[a[d].links[c]].level){a[d].down.push(a[d].links[c]);a[d].showState="expansion"}}}}function T(e,t){var r,a;e.dispatch("onRayShrink",i);function i(e,i){r=t.nodeIdDict;a=t.pointsSystemDict;if(e!==undefined){var s=e.object.geometry.idsList[e.index];if(r[s].showState!==undefined){if(r[s].showState==="expansion"){r[s].showState="shrink";n(s,s)}else if(r[s].showState==="shrink"){r[s].showState="expansion";o(s,s)}}}}function n(e,t){for(var a=0;a<r[e].down.length;a++){s(r[e].down[a],t,"shrink");n(r[e].down[a],t)}}function o(e,t){for(var a=0;a<r[e].down.length;a++){s(r[e].down[a],t,"expansion");if(r[r[e].down[a]].showState==="expansion"){o(r[e].down[a],t)}else if(r[r[e].down[a]].showState==="shrink"){n(r[e].down[a],r[e].down[a])}}}function s(e,t,i){var n;var o=a["line"];var s=a[r[e].topoType];var d=s.geometry.idsList;for(var c=0;c<d.length;c++){if(e===d[c]){n=c;break}}if(n==undefined){console.error(n);return n}var u=r[e];var l;if(i=="shrink"){l={x:r[t].coord3X,y:r[t].coord3Y,z:r[t].coord3Z}}else if(i=="expansion"){l={x:u.coord3X,y:u.coord3Y,z:u.coord3Z}}new TWEEN.Tween({x:u.x,y:u.y,z:u.z}).to({x:l.x,y:l.y,z:l.z},1e3).easing(TWEEN.Easing.Linear.None).onUpdate(function(){if(i=="expansion"){s.geometry.attributes.customOpacity.array[n]=1;s.geometry.attributes.customOpacity.needsUpdate=true;s.geometry.attributes.customSize.array[n]=1;s.geometry.attributes.customSize.needsUpdate=true}s.geometry.attributes.position.array[n*3]=this.x;s.geometry.attributes.position.array[n*3+1]=this.y;s.geometry.attributes.position.array[n*3+2]=this.z;s.geometry.attributes.position.needsUpdate=true;r[e].x=this.x;r[e].y=this.y;r[e].z=this.z;o.geometry.verticesNeedUpdate=true}).onComplete(function(){if(i=="shrink"){s.geometry.attributes.customOpacity.array[n]=0;s.geometry.attributes.customOpacity.needsUpdate=true;s.geometry.attributes.customSize.array[n]=0;s.geometry.attributes.customSize.needsUpdate=true}TWEEN.remove()}).start()}}function R(t,r,a){if(e.themeConfig.enableRayMark){var i=c.loadPicture(o.multi_mark);function n(){var e=new THREE.SpriteMaterial({map:i,color:16777071,opacity:.8,transparent:true});var t=new THREE.Sprite(e);t.visible=false;return t}var s={};var d=[];var u={}}var l=[];t.dispatch("onRayComplete",f);function f(t,a,i){if(a.type=="click"||a.type=="mouseup"){if(t!==undefined){var o;var c,f,v;var p;if(t.object.nodeId){o=t.object.nodeId}else{o=t.object.geometry.idsList[t.index]}if(a.button==0){if(t.nodeId){var E=t.topoType.geometry.idsList;for(var m=0;m<E.length;m++){if(E[m]==t.nodeId){p=m}}c=t.topoType.geometry.attributes.position.array[p*3];f=t.topoType.geometry.attributes.position.array[p*3+1];v=t.topoType.geometry.attributes.position.array[p*3+2]}else{p=t.index;c=t.object.geometry.attributes.position.array[p*3];f=t.object.geometry.attributes.position.array[p*3+1];v=t.object.geometry.attributes.position.array[p*3+2]}if(a.ctrlKey){if(l.length>0){for(var y=0;y<l.length;y++){if(l[y]==o){l.splice(y,1);break}else if(y==l.length-1){l.push(o);break}}}else{l.push(o)}if(e.themeConfig.enableRayMark){T(o)}}else{l=new Array;l.push(o);if(e.themeConfig.enableRayMark){for(var g in s){var w=s[g];w.scale.set(1,1,1);w.position.set(0,0,0);w.visible=false;r.remove(w);d.push(w);TWEEN.remove(u[g]);w.material.rotation=0}s=new Object;u=new Object;T(o)}}function T(e){if(!u[e]){if(d.length==0){var a;if(t.nodeId){a=t.topoType.material.uniforms.size.value}else{a=t.object.material.uniforms.size.value}var i=n();i.scale.set(a,a,1);i.position.x=c;i.position.y=f;i.position.z=v;i.visible=true;s[e]=i;r.add(i);var o=new TWEEN.Tween({rotation:.01}).to({rotation:.01},2e3).easing(TWEEN.Easing.Linear.None).onUpdate(function(){i.material.rotation-=.01}).repeat(Infinity);o.start();u[e]=o}else{var a;if(t.nodeId){a=t.topoType.material.uniforms.size.value}else{a=t.object.material.uniforms.size.value}var i=d.shift();i.scale.set(a,a,1);i.position.x=c;i.position.y=f;i.position.z=v;i.visible=true;s[e]=i;r.add(i);var o=new TWEEN.Tween({rotation:.01}).to({rotation:.01},2e3).easing(TWEEN.Easing.Quadratic.InOut).onUpdate(function(){i.material.rotation-=.01}).repeat(Infinity);o.start();u[e]=o}}else{var i=s[e];i.scale.set(1,1,1);i.position.set(0,0,0);i.visible=false;r.remove(i);d.push(i);delete s[e];delete u[e];i.material.rotation=0}}}}else{if(e.themeConfig.enableRayMulti&&!h){if(e.themeConfig.enableRayMark){for(var g in s){var w=s[g];w.scale.set(1,1,1);w.position.set(0,0,0);w.visible=false;r.remove(w);d.push(w);TWEEN.remove(u[g]);w.material.rotation=0}s=new Object;u=new Object}l=new Array}}return l}else if(a.type=="dblclick"){if(t!==undefined){if(t.object.nodeId){o=t.nodeId}else{o=t.object.geometry.idsList[t.index]}if(a.button==0){var p=t.index;var c=t.object.geometry.attributes.position.array[p*3];var f=t.object.geometry.attributes.position.array[p*3+1];var v=t.object.geometry.attributes.position.array[p*3+2]}}}}}function b(e){var t=e.fov;var r=e.aspect!==undefined?e.aspect:window.innerWidth/window.innerHeight;var a=e.near!==undefined?e.near:1;var i=e.far!==undefined?e.far:1e5;var n=0;var o=Math.PI;var s=1e-6;var d=new THREE.PerspectiveCamera(t,r,a,i);d.resize=function(){d.aspect=window.innerWidth/window.innerHeight;d.updateProjectionMatrix()};if(d instanceof THREE.PerspectiveCamera){d.target=new THREE.Vector3;d.radius=1e4;d.phi=0;d.theta=0}var c=d.radius*Math.sin(d.phi)*Math.sin(d.theta)+d.target.x;var u=d.radius*Math.cos(d.phi)+d.target.y;var l=d.radius*Math.sin(d.phi)*Math.cos(d.theta)+d.target.z;d.position.set(c,u,l);var f=Math.PI;d.moveTo=function(e,t){var r=this;var a=e.targetX!==undefined?e.targetX:d.target.x;var i=e.targetY!==undefined?e.targetY:d.target.y;var n=e.targetZ!==undefined?e.targetZ:d.target.z;var o=e.radius!==undefined?e.radius:d.radius;var s=e.phi!==undefined?e.phi:d.phi;var c=e.theta!==undefined?e.theta:d.theta;var u=e.during!==undefined?e.during:2e3;var l=e.delay!==undefined?e.delay:0;if(a!==r.target.x||i!==r.target.y||n!==r.target.z||o!==r.radius||s!==r.phi||c!==r.theta){new TWEEN.Tween({targetX:r.target.x,targetY:r.target.y,targetZ:r.target.z,radius:r.radius,phi:r.phi,theta:r.theta}).to({targetX:a,targetY:i,targetZ:n,radius:o,phi:s,theta:c},u).easing(TWEEN.Easing.Quadratic.InOut).delay(l).onUpdate(function(){r.target.set(this.targetX,this.targetY,this.targetZ);r.radius=this.radius;r.phi=this.phi;r.theta=this.theta;r.update()}).onComplete(function(){if(typeof t=="function"){t()}TWEEN.remove(this)}).start()}else{if(typeof t=="function"){t()}TWEEN.remove(this)}};d.set=function(e){d.target.x=e.targetX!==undefined?e.targetX:d.target.x;d.target.y=e.targetY!==undefined?e.targetY:d.target.y;d.target.z=e.targetZ!==undefined?e.targetZ:d.target.z;d.radius=e.radius!==undefined?e.radius:d.radius;d.phi=e.phi!==undefined?e.phi:d.phi;d.theta=e.theta!==undefined?e.theta:d.theta;d.update()};d.update=function(){var e=d;e.phi=Math.max(n,Math.min(o,e.phi));e.phi=Math.max(s,Math.min(Math.PI-s,e.phi));e.position.x=e.target.x+e.radius*Math.sin(e.phi)*Math.sin(e.theta);e.position.y=e.target.y+e.radius*Math.cos(e.phi);e.position.z=e.target.z+e.radius*Math.sin(e.phi)*Math.cos(e.theta);e.lookAt(e.target)};d.posRedefine=function(e){var t=d;var r=e.cameraPos!==undefined?new THREE.Vector3(e.cameraPos[0],e.cameraPos[1],e.cameraPos[2]):new THREE.Vector3(0,2e3,2e3);var a=e.targetPos!==undefined?new THREE.Vector3(e.targetPos[0],e.targetPos[1],e.targetPos[2]):new THREE.Vector3(0,0,0);t.target.x=a.x;t.target.y=a.y;t.target.z=a.z;var i=(new THREE.Vector3).copy(r).sub(a);t.radius=i.length();t.phi=Math.atan2(Math.sqrt(i.x*i.x+i.z*i.z),i.y);t.theta=Math.atan2(i.x,i.z);t.update()};return d}var x=function(e,t){var a=this;this.enabled=true;this.noRotate=false;this.rotateSpeed=1;this.noPan=false;this.noZoom=false;this.object=e;var i=0;var n=Math.PI;var o=this.object;var t=t!==undefined?t:r;this.minDistance=200;this.maxDistance=Infinity;var s=1e-6;var d=new THREE.Vector2;var c=new THREE.Vector2;var u=new THREE.Vector2;var f=new THREE.Vector2;var h=new THREE.Vector2;var p=new THREE.Vector2;var E=new THREE.Vector2;var m=new THREE.Vector2;var y=new THREE.Vector2;var g=0;var w=0;var T=1;var R=1;var b=new THREE.Vector3;var x={NONE:-1,ROTATE:0,DOLLY:1,PAN:2};var H=x.NONE;t.addEventListener("contextmenu",function(e){e.preventDefault()},false);t.addEventListener("mousedown",C,false);t.addEventListener("wheel",z,false);function C(e){v=false;if(!e.ctrlKey){if(a.enabled===false){return}e.preventDefault();if(e.button===0){if(a.noRotate===true){return}H=x.ROTATE;d.set(e.clientX,e.clientY)}else if(e.button===1){if(a.noZoom===true){return}H=x.DOLLY;E.set(e.clientX,e.clientY)}else if(e.button===2){if(a.noPan===true){return}H=x.PAN;f.set(e.clientX,e.clientY)}}t.addEventListener("mousemove",M,false);t.addEventListener("mouseup",S,false)}function M(e){if(e.ctrlKey){return}else{if(a.enabled===false)return;e.preventDefault();if(H===x.ROTATE){if(a.noRotate===true)return;c.set(e.clientX,e.clientY);u.subVectors(c,d);if(u.length()!==0){v=true}P(2*Math.PI*u.x/t.clientWidth*a.rotateSpeed);I(2*Math.PI*u.y/t.clientHeight*a.rotateSpeed);d.copy(c)}else if(H===x.DOLLY){if(a.noZoom===true)return;m.set(e.clientX,e.clientY);y.subVectors(m,E);if(y.y>0||y.x<0){j()}else{k()}E.copy(m)}else if(H===x.PAN){if(a.noPan===true)return;h.set(e.clientX,e.clientY);p.subVectors(h,f);D(p);f.copy(h)}a.update()}}function S(e){t.removeEventListener("mousemove",M,false);t.removeEventListener("mouseup",S,false);if(e.ctrlKey){return}else{if(a.enabled===false)return;H=x.NONE}}function z(e){if(a.enabled===false||a.noZoom===true)return;var t=0;if(e.deltaY){t=-e.deltaY}else if(e.wheelDelta){t=e.wheelDelta}else if(e.detail){t=-e.detail}if(t>0){k()}else{j()}a.update();if(typeof l=="function"){l()}}function P(e){w-=e}function I(e){g-=e}function _(e){var t=new THREE.Vector3;var r=o.matrix.elements;t.set(r[0],r[1],r[2]);t.multiplyScalar(-e);b.add(t)}function V(e){var t=new THREE.Vector3;var r=o.matrix.elements;t.set(r[4],r[5],r[6]);t.multiplyScalar(e);b.add(t)}function D(e){if(o.fov!==undefined){var r=o.position;var a=r.clone().sub(o.target);var i=a.length();i*=Math.tan(o.fov/2*Math.PI/180);_(2*e.x*i/t.clientHeight);V(2*e.y*i/t.clientHeight)}else if(o.top!==undefined){_(e.x*(o.right-o.left)/t.clientWidth);V(e.y*(o.top-o.bottom)/t.clientHeight)}}function j(e){if(e===undefined){e=Y()}T/=e}function k(e){if(e===undefined){e=Y()}T*=e}function Y(){return Math.pow(.95,R)}this.update=function(){var e=o.position;var t=new THREE.Vector3;var r=o.theta;var d=o.phi;r+=w;d+=g;d=Math.max(i,Math.min(n,d));d=Math.max(s,Math.min(Math.PI-s,d));var c=o.radius*T;c=Math.max(a.minDistance,Math.min(a.maxDistance,c));o.target.add(b);t.x=c*Math.sin(d)*Math.sin(r);t.y=c*Math.cos(d);t.z=c*Math.sin(d)*Math.cos(r);e.copy(o.target).add(t);o.lookAt(o.target);o.theta=r;o.phi=d;o.radius=c;w=0;g=0;T=1;b.set(0,0,0)}};function H(){var e=new THREE.Object3D;this.segmentRadius=150;this.laps=70;this.segmentHeight=Math.cos(Math.PI/6)*this.segmentRadius;this.geometry=new THREE.Geometry;this.paths=[];for(var t=0;t<this.laps;t++){if(t==0){var r=new THREE.EllipseCurve(0,0,this.segmentRadius,this.segmentRadius,0,0,false);this.paths.push(r)}else{var a=6;var i=t*2*this.segmentHeight;var r=new THREE.EllipseCurve(0,0,i,i,Math.PI/2,2*Math.PI+Math.PI/2,false);var n=[];for(var o=0;o<a;o++){var s=r.getPoint(o/a);n.push(s)}for(var o=0;o<n.length;o++){var d;if(o==n.length-1){d=new THREE.LineCurve(n[o],n[0])}else{d=new THREE.LineCurve(n[o],n[o+1])}for(var c=0;c<=t;c++){var s=d.getPoint(c/t);var r=new THREE.EllipseCurve(s.x,s.y,this.segmentRadius,this.segmentRadius,0,2*Math.PI,false);this.paths.push(r)}}}}for(var t=0;t<this.paths.length;t++){var d=this.paths[t];for(var o=0;o<=6;o++){var u=d.getPoint(o/6);if(o==0||o==6){this.geometry.vertices.push(new THREE.Vector3(u.x,u.y,0))}else{this.geometry.vertices.push(new THREE.Vector3(u.x,u.y,0));this.geometry.vertices.push(new THREE.Vector3(u.x,u.y,0))}}}this.geometry.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2));this.obj=new THREE.Line(this.geometry,new THREE.LineBasicMaterial({color:141361}),THREE.LinePieces);this.obj.position.set(0,-200,0);e.add(this.obj);return e}function C(){var e=2e3;var t=1e4;var r=25e3;var a=r-t;var i=new THREE.PointsMaterial({size:100,map:c.loadPicture(o.Star),blending:THREE.AdditiveBlending,transparent:true,opacity:1,color:16777215,alphaTest:.1});var n=new THREE.BufferGeometry;var s=new Float32Array(e*3);for(var d=0;d<e;d++){var u=Math.random()*a+t;var l=(Math.random()*180-90)*Math.PI/180;var f=(Math.random()*360-180)*Math.PI/180;s[d*3]=u*Math.cos(l)*Math.sin(f);s[d*3+1]=u*Math.sin(l);s[d*3+2]=u*Math.cos(l)*Math.cos(f)}n.addAttribute("position",new THREE.BufferAttribute(s,3));var v=new THREE.Points(n,i);return v}function M(){var e={loadPicture:function(e){return(new THREE.TextureLoader).load(n+e)},loadWord:function(e){var t=new THREE.Texture(e);t.needsUpdate=true;return t}};return e}function S(t,a){var i=e.themeConfig.line_color!==undefined?e.themeConfig.line_color:35054;var n=e.themeConfig.isAnimateNodes!==undefined?e.themeConfig.isAnimateNodes:false;var u=e.themeConfig._2Direction!==undefined?e.themeConfig._2Direction:"XY";var l={};var f=new THREE.Object3D;var v={};var h={};for(var E in t){for(var m in t[E]){if(m!=="level"&&m!=="Square"){if(h[m]!==undefined){h[m]=h[m].concat(t[E][m])}else{h[m]=[];h[m]=h[m].concat(t[E][m])}}}}for(var m in h){if(m!=="level"&&m!=="Square"){var y=h[m];var g=s[m]!==undefined?s[m]:180;if(o[m]==undefined&&s["undefine"]!=undefined){g=s["undefine"]}var w=o[m]!==undefined?o[m]:o["undefine"];var T=_(g,w,y,m);f.add(T);a.add(T)}}var R=new THREE.Geometry;var b,x;var H;for(var C in l){b=l[C];for(var M=0;M<l[C]["links"].length;M++){H=l[C]["links"][M];x=l[H];if(x!==undefined){R.vertices.push(b);R.vertices.push(x);R.colors.push(new THREE.Color(i));R.colors.push(new THREE.Color(i))}}}var S=new THREE.LineBasicMaterial({color:16777215,opacity:.6,transparent:true,vertexColors:THREE.VertexColors});var P=new THREE.LineSegments(R,S);v["line"]=P;f.add(P);f.openingAnimate=function(e,r){if(n){var e=e!==undefined?e:{};var a=e.during!==undefined?e.during:1e3;var i=e.delay!==undefined?e.delay:1e3;var r=r!==undefined?r:undefined;var o=[];for(var s in t){var d=t[s];for(var c=0;c<d["level"].length;c++){if(o[c]!==undefined){o[c]=o[c].concat(d["level"][c])}else{o[c]=[];o[c]=o[c].concat(d["level"][c])}}}for(var u=0;u<o.length;u++){var l=o[u].concat();for(var f=0;f<l.length;f++){I(l[f],a,i*u)}if(u==o.length-1){new TWEEN.Tween({percent:0}).to({percent:1},a).easing(TWEEN.Easing.Linear.None).delay(i*u).onComplete(function(){r!==undefined&&r();for(var e in v){v[e].geometry.computeBoundingSphere()}TWEEN.remove(this)}).start()}}}};return{pointsSystem:f,nodeIdDict:l,pointsSystemDict:v};function I(e,t,r){switch(u){case"XY":case"YX":var i=l[e].coord3X-l[e].coord2X;var n=l[e].coord3Y-l[e].coord2Y;var o=l[e].coord3Z;break;case"XZ":case"ZX":var i=l[e].coord3X-l[e].coord2X;var n=l[e].coord3Y;var o=l[e].coord3Z-l[e].coord2Y;break;case"YZ":case"ZY":var i=l[e].coord3X;var n=l[e].coord3Y-l[e].coord2X;var o=l[e].coord3Z-l[e].coord2Y;break}var s=l[e].topoType;var d=v[s];var c;for(var f=0,h=d.geometry.idsList.length;f<h;f++){if(d.geometry.idsList[f]==e){c=f;break}}new TWEEN.Tween({percent:0}).to({percent:1},t).easing(TWEEN.Easing.Linear.None).delay(r).onUpdate(function(){switch(u){case"XY":case"YX":d.geometry.attributes.position.array[c*3]=i*this.percent+l[e].coord2X;d.geometry.attributes.position.array[c*3+1]=n*this.percent+l[e].coord2Y;d.geometry.attributes.position.array[c*3+2]=o*this.percent;d.geometry.attributes.position.needsUpdate=true;l[e].x=i*this.percent+l[e].coord2X;l[e].y=n*this.percent+l[e].coord2Y;l[e].z=o*this.percent;P.geometry.verticesNeedUpdate=true;break;case"XZ":case"ZX":d.geometry.attributes.position.array[c*3]=i*this.percent+l[e].coord2X;d.geometry.attributes.position.array[c*3+1]=n*this.percent;d.geometry.attributes.position.array[c*3+2]=o*this.percent+l[e].coord2Y;d.geometry.attributes.position.needsUpdate=true;l[e].x=i*this.percent+l[e].coord2X;l[e].y=n*this.percent;l[e].z=o*this.percent+l[e].coord2Y;P.geometry.verticesNeedUpdate=true;break;case"YZ":case"ZY":d.geometry.attributes.position.array[c*3]=i*this.percent;d.geometry.attributes.position.array[c*3+1]=n*this.percent+l[e].coord2X;d.geometry.attributes.position.array[c*3+2]=o*this.percent+l[e].coord2Y;d.geometry.attributes.position.needsUpdate=true;l[e].x=i*this.percent;l[e].y=n*this.percent+l[e].coord2X;l[e].z=o*this.percent+l[e].coord2Y;P.geometry.verticesNeedUpdate=true;break}}).onComplete(function(){a.update();TWEEN.remove(this)}).start()}function _(e,t,a,i){var o=1e4;var s=a.length;var f=new Float32Array(o*3);var h=new Float32Array(o*3);var E=new Float32Array(o);var m=new Float32Array(o);var y=[];var g,w;for(var T=0;T<o;T++){if(T<s){w=new THREE.Vector3;if(n){switch(u){case"XY":case"YX":w.x=a[T][5];w.y=a[T][6];w.z=0;break;case"XZ":case"ZX":w.x=a[T][5];w.y=0;w.z=a[T][6];break;case"YZ":case"ZY":w.x=0;w.y=a[T][5];w.z=a[T][6];break}}else{w.x=a[T][1];w.y=a[T][2];w.z=a[T][3]}w.toArray(f,T*3);E[T]=1;m[T]=1;g=new THREE.Color(16777215);g.toArray(h,T*3);w.uid=a[T][0];w.links=a[T][4];w.coord3X=a[T][1];w.coord3Y=a[T][2];w.coord3Z=a[T][3];w.index=T;w.coord2X=a[T][5];w.coord2Y=a[T][6];w.topoType=i;l[a[T][0]]=w;y.push(a[T][0])}else{w=new THREE.Vector3;w.toArray(f,T*3);E[T]=1;m[T]=1;g=new THREE.Color(16777215);g.toArray(h,T*3)}}var R=new THREE.BufferGeometry;R.addAttribute("position",new THREE.BufferAttribute(f,3).setDynamic(true));R.addAttribute("customColor",new THREE.BufferAttribute(h,3).setDynamic(true));R.addAttribute("customOpacity",new THREE.BufferAttribute(E,1).setDynamic(true));R.addAttribute("customSize",new THREE.BufferAttribute(m,1).setDynamic(true));R.setDrawRange(0,s);R.idsList=y;var b=$(r).width()/$(r).height();var x;if(t=="wordPNG"){if(d[i]){var H=d[i][0];var C=d[i][1];var M=d[i][2];var S=z(H,C,M);x=new THREE.ShaderMaterial({uniforms:{size:{type:"f",value:e},pixelRatio:{type:"f",value:b},opacity:{type:"f",value:1},color:{type:"c",value:new THREE.Color(16777215)},texture:{type:"t",value:c.loadWord(S)}},vertexShader:p.nodeSystem.vertexShader,fragmentShader:p.nodeSystem.fragmentShader,transparent:true,alphaTest:.9})}}else{x=new THREE.ShaderMaterial({uniforms:{size:{type:"f",value:e},pixelRatio:{type:"f",value:b},opacity:{type:"f",value:1},color:{type:"c",value:new THREE.Color(16777215)},texture:{type:"t",value:c.loadPicture(t)}},vertexShader:p.nodeSystem.vertexShader,fragmentShader:p.nodeSystem.fragmentShader,transparent:true,alphaTest:.9})}var P=new THREE.Points(R,x,e/7);P.topoType=i;v[i]=P;return P}}function z(e,t,r){var t=t!==undefined?t:35054;var r=r!==undefined?r:16777215;var a=document.createElement("canvas");var i=a.getContext("2d");var n=e.length;i.font="bold "+512/n+"px 微软雅黑";a.width=512+512/n;a.height=512;var o=new THREE.Color(t);i.fillStyle="rgba("+o.r*255+","+o.g*255+","+o.b*255+",0.5)";i.fillRect(0,256-512/n/2-512/n/3,a.width,512/n+512/n/3*2);var s=new THREE.Color(r);i.fillStyle="rgb("+s.r*255+","+s.g*255+","+s.b*255+")";i.textBaseline="middle";i.textAlign="center";i.font="bold "+512/n+"px 微软雅黑";i.fillText(e,a.width/2,a.height/2);return a}function P(e){var t=new THREE.Object3D;var r=e[3][0]-e[2][0]/2;var a=e[3][0]+e[2][0]/2;var i=e[3][1]-e[2][1]/2;var n=e[3][1]+e[2][1]/2;var o=e[3][2]-e[2][2]/2;var s=e[3][2]+e[2][2]/2;var d=e[4];var c=new THREE.LineDashedMaterial({dashSize:10,gapSize:10});c.color=new THREE.Color(d);var u=new THREE.Geometry;u.vertices.push(new THREE.Vector3(r,i,o));u.vertices.push(new THREE.Vector3(r,i,s));u.vertices.push(new THREE.Vector3(r,i,o));u.vertices.push(new THREE.Vector3(r,n,o));u.vertices.push(new THREE.Vector3(r,i,o));u.vertices.push(new THREE.Vector3(a,i,o));u.vertices.push(new THREE.Vector3(a,i,o));u.vertices.push(new THREE.Vector3(a,n,o));u.vertices.push(new THREE.Vector3(a,i,o));u.vertices.push(new THREE.Vector3(a,i,s));u.vertices.push(new THREE.Vector3(r,i,s));u.vertices.push(new THREE.Vector3(a,i,s));u.vertices.push(new THREE.Vector3(r,i,s));u.vertices.push(new THREE.Vector3(r,n,s));u.vertices.push(new THREE.Vector3(r,n,o));u.vertices.push(new THREE.Vector3(a,n,o));u.vertices.push(new THREE.Vector3(r,n,o));u.vertices.push(new THREE.Vector3(r,n,s));u.vertices.push(new THREE.Vector3(r,n,s));u.vertices.push(new THREE.Vector3(a,n,s));u.vertices.push(new THREE.Vector3(a,n,o));u.vertices.push(new THREE.Vector3(a,n,s));u.vertices.push(new THREE.Vector3(a,i,s));u.vertices.push(new THREE.Vector3(a,n,s));u.computeLineDistances();var l=new THREE.LineSegments(u,c);t.add(l);if(e[5].length>0){var f=document.createElement("canvas");var v=f.getContext("2d");v.font="bold "+e[7]+"px 微软雅黑";f.width=v.measureText(e[5]).width+e[8]*2;f.height=e[7]+e[8]*2;var h=new THREE.Color(e[9]);v.fillStyle="rgb("+h.r*255+","+h.g*255+","+h.b*255+")";v.fillRect(0,0,f.width,f.height);var p=new THREE.Color(e[6]);v.fillStyle="rgb("+p.r*255+","+p.g*255+","+p.b*255+")";v.textBaseline="middle";v.textAlign="center";v.font="bold "+e[7]+"px 微软雅黑";v.fillText(e[5],f.width/2,f.height/2);var E=new THREE.Texture(f);E.needsUpdate=true;var m=new THREE.PlaneBufferGeometry(f.width,f.height);var y=new THREE.MeshBasicMaterial({side:THREE.DoubleSide,map:E,transparent:true,blending:THREE.AdditiveBlending,depthTest:false});var g=new THREE.Mesh(m,y);g.rotation.x=-Math.PI/2;g.position.set(r+f.width/2+20,n,s-f.height/2-20);t.add(g)}return t}function I(e){var t=document.createElement("canvas");var r=t.getContext("2d");r.font="bold "+e[4]+"px 微软雅黑";t.width=r.measureText(e[2]).width+e[5]*2;t.height=e[4]+e[5]*2;var a=new THREE.Color(e[6]);r.fillStyle="rgba("+a.r*255+","+a.g*255+","+a.b*255+",0.5)";r.fillRect(0,0,t.width,t.height);var i=new THREE.Color(e[3]);r.fillStyle="rgb("+i.r*255+","+i.g*255+","+i.b*255+")";r.textBaseline="middle";r.textAlign="center";r.font="bold "+e[4]+"px 微软雅黑";r.fillText(e[2],t.width/2,t.height/2);var n=new THREE.Texture(t);n.needsUpdate=true;var o=new THREE.Sprite(new THREE.SpriteMaterial({map:n,transparent:true}));o.position.set(e[7][0],e[7][1],e[7][2]);o.scale.set(t.width,t.height,1);return o}function _(t,r,a){var i=H();t.add(i);var n=r["json_data"];var o=r["squares"]!==undefined?r["squares"]:[];var s=r["notices"]!==undefined?r["notices"]:[];var d=e.themeConfig.baseShow!==undefined?e.themeConfig.baseShow:false;var c=e.themeConfig.baseDelay;if(d){setTimeout(function(){for(var e=0;e<o.length;e++){var r=o[e];var a=P(r);t.add(a)}for(var i=0;i<s.length;i++){var n=s[i];var d=I(n);t.add(d)}},c)}var u=S(n,a);var l=u.pointsSystem;var f=u.pointsSystemDict;t.add(l);var a=u.octree;var v=u.nodeIdDict;function h(e){var r=[];for(var a in v){var i=t.localToWorld(v[a].clone());var n=i.project(e);n.nodeId=a;n.topoType=f[v[a].topoType];r.push(n)}return r}var p={nodeIdDict:v,topo_node_line:l,pointsSystemDict:f,getAllPosition:h};return p}var V=E();return V}return e});