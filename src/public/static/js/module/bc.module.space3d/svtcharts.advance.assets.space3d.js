requirejs.config({baseUrl:"./js",paths:{display:"module/bc.module.space3d/basic.display",effect:"module/bc.module.space3d/basic.effect.update",texure:"module/bc.module.space3d/basic.textureLibs",extensions:"module/bc.module.space3d/basic.extensions",config:"module/bc.module.space3d/basic.config",speed:"module/bc.module.space3d/speedConfig"}});define(["display","effect","extensions","texure","config","speed"],function(e,t,i){console.info("Space3DV20171120");let a=speedConfig.eachInterval;function n(n){let r;$.ajaxSettings.async=false;$.getJSON(n.topoStructure,function(e){$("#failtip").css("z-index",-1);if(e.status=="success"){r=e.data;$("#failtip").css("z-index",-1)}else{if(e.data=="no topo"){$("#inturn").css("display","none");$("#draw").css("display","inline-block")}else{$("#inturn").css("display","none");$("#fail").css("display","inline-block")}}}).fail(function(){$("#inturn").css("display","none");$("#fail").css("display","inline-block")});let s=[];let o=new THREE.Object3D;let d=[];let l=[];let c={};let u={};let p={};let f={};let b=[];let g=[];let m=[];let E={trojanType:{},tsunam:{},wannacry:{}};var x={id:"nodeid",run:"run",trojanType:"trojanType",apt:"apt",tsunam:"tsunam",wannacry:"wannacry"};const h={topoDivId:"topo",topoControlsDivId:"controls",themeConfig:basic_theme_config,texturesRoot:Space3D_Textures.texturesRoot,textureslibs:Space3D_Textures.texturesLibs,texturesSize:Space3D_Textures.texturesSize,topoS:r,animate:N,zoomupdate:G};var v=e(h);v.camera.set({targetX:-186.73726184486858,targetY:112.0050139686209,targetZ:177.19216928517415,radius:3500,phi:1.18,theta:.33915198965276366});let D=150;let T=new THREE.SpriteMaterial({map:v.texturesLibrary.loadPicture(Space3D_Textures.texturesLibs.multi_mark)});var S=new THREE.Sprite(T);S.visible=false;S.scale.set(D,D);let y=130;var w=new THREE.Sprite(new THREE.SpriteMaterial({map:v.texturesLibrary.loadPicture(Space3D_Textures.texturesLibs.select)}));let I=65;const R={texturesRoot:Space3D_Textures.texturesRoot,textureslibs:Space3D_Textures.texturesLibs,texturesSize:Space3D_Textures.texturesSize,system:v};const L=t(R);const H=new THREE.Object3D;v.stage.add(H);H.add(S);H.add(o);function C(e,t){var i=document.createElement("canvas");i.width=512;i.height=512;var a=i.getContext("2d");var n=a.createRadialGradient(i.width/2,i.height/2,0,i.width/2,i.height/2,i.width/2);n.addColorStop(0,"rgba(0, 0, 0, 0)");n.addColorStop(.5,e);n.addColorStop(.6,t);n.addColorStop(1,"rgba(0, 0, 0, 0)");a.fillStyle=n;a.fillRect(0,0,i.width,i.height);var r=new THREE.Texture(i);r.needsUpdate=true;return r}function M(e,t,i,a,n){if(i.length<=0){var r=t.clone();r.position.set(v.nodeIdDict[e].x,v.nodeIdDict[e].y,v.nodeIdDict[e].z);a.add(r);n[e]=r}else{i[0].position.set(v.nodeIdDict[e].x,v.nodeIdDict[e].y,v.nodeIdDict[e].z);a.add(i[0]);n[e]=i[0];i.splice(0,1)}}function j(e,t,i,a){t.push(i[e]);a.remove(i[e]);delete i[e]}let _=1;let k=1;var z={0:"blank",1:new THREE.SpriteMaterial({map:v.texturesLibrary.loadPicture(Space3D_Textures.texturesLibs.offline)}),2:new THREE.SpriteMaterial({map:v.texturesLibrary.loadPicture(Space3D_Textures.texturesLibs.control)}),3:new THREE.SpriteMaterial({map:v.texturesLibrary.loadPicture(Space3D_Textures.texturesLibs.palsy)})};let P={0:"blank",1:new THREE.SpriteMaterial({map:v.texturesLibrary.loadPicture(Space3D_Textures.texturesLibs.trojanType),color:16711680}),2:new THREE.SpriteMaterial({map:v.texturesLibrary.loadPicture(Space3D_Textures.texturesLibs.trojanType),color:16728576}),3:new THREE.SpriteMaterial({map:v.texturesLibrary.loadPicture(Space3D_Textures.texturesLibs.trojanType),color:16751616}),4:new THREE.SpriteMaterial({map:v.texturesLibrary.loadPicture(Space3D_Textures.texturesLibs.trojanType),color:16763904}),5:new THREE.SpriteMaterial({map:v.texturesLibrary.loadPicture(Space3D_Textures.texturesLibs.trojanType),color:16774656})};let B={0:"blank",1:16711680,2:16728576,3:16751616,4:16763904,5:16774656};function F(e){var t=document.createElement("canvas");t.width=32;t.height=32;var i=t.getContext("2d");var a=i.createRadialGradient(t.width/2,t.height/2,0,t.width/2,t.height/2,t.width/2);a.addColorStop(0,e);a.addColorStop(1,"rgba(0, 0, 0, 0)");i.fillStyle=a;i.fillRect(0,0,t.width,t.height);var n=new THREE.Texture(t);n.needsUpdate=true;return n}function G(){}function N(){let e=Date.now()*.0035;TWEEN.update();if(S!=undefined){S.material.rotation-=.01}if(w!=undefined){w.material.rotation-=.01}let t=Math.ceil(e/20)*20-e;if(t<2*Math.PI){let e=400+40*Math.cos(t+Math.PI);for(var i in u){u[i].scale.set(e,e,1)}for(var i in p){p[i].scale.set(e,e,1)}}for(i in f){f[i].rotation.y+=Math.PI/30}}var O={};function X(e,t,i,a){if(v.nodeIdDict[e]==undefined){}else{if(i.length<=0){var n=t.clone();n.position.x=v.nodeIdDict[e].x;n.position.y=v.nodeIdDict[e].y;n.position.z=v.nodeIdDict[e].z;n.scale.set(y,y);a.add(n)}else{i[0].position.x=v.nodeIdDict[e].x;i[0].position.y=v.nodeIdDict[e].y;i[0].position.z=v.nodeIdDict[e].z;a.add(i[0]);i[0].scale.set(y,y);i.splice(0,1)}}}function Y(e,t){while(e.children.length>0){t.push(e.children[0]);e.remove(e.children[0])}}function Z(e,t){console.info(e);O.clickHandler(e);if(e!=undefined){S.position.set(v.nodeIdDict[e].x,v.nodeIdDict[e].y,v.nodeIdDict[e].z);S.visible=true;v.camera.moveTo({targetX:v.nodeIdDict[e].x,targetY:v.nodeIdDict[e].y,targetZ:v.nodeIdDict[e].z,radius:basic_theme_config.RayRadius,during:500})}else{S.visible=false}}v.rayFunc.dispatch("onRayShowInfo",Z);function A(e,t){O.clickHandler(e);if(e!=undefined){S.position.set(v.nodeIdDict[e].x,v.nodeIdDict[e].y,v.nodeIdDict[e].z);S.visible=true;v.camera.moveTo({targetX:v.nodeIdDict[e].x,targetY:v.nodeIdDict[e].y,targetZ:v.nodeIdDict[e].z,radius:basic_theme_config.RayRadius,during:500})}else{S.visible=false}}v.rayFunc.dispatch("onRayShowInter",A);var q=i();q.pathTreeBuild(v.nodeIdDict);O.selectHandler=function(e,t){var i=false;if(e==false){Y(o,s)}else{if(t==true){Y(o,s);if(typeof e=="object"){for(var a=0;a<e.length;a++){if(v.nodeIdDict[e[a]]!=undefined){X(e[a],w,s,o);i=true}}}else{if(v.nodeIdDict[e]!=undefined){X(e,w,s,o);v.camera.moveTo({targetX:v.nodeIdDict[e].x,targetY:v.nodeIdDict[e].y,targetZ:v.nodeIdDict[e].z,radius:basic_theme_config.RayRadius,during:500});i=true}}}else{if(v.nodeIdDict[e]!=undefined){i=true;S.position.set(v.nodeIdDict[e].x,v.nodeIdDict[e].y,v.nodeIdDict[e].z);S.visible=true;v.camera.moveTo({targetX:v.nodeIdDict[e].x,targetY:v.nodeIdDict[e].y,targetZ:v.nodeIdDict[e].z,radius:basic_theme_config.RayRadius,during:500})}}}return i};function U(e,t,i,a,n){if(a[t]=="blank"){if(E[i][e]!=undefined){d.push(E[i][e]);n.remove(E[i][e]);delete E[i][e]}}else{var r=i+t;if(E[i][e]==undefined){if(d.length<=0){var s=new THREE.Sprite(a[t]);s.tag=r;s.scale.set(advance_config.layersize,advance_config.layersize,1);s.position.set(v.nodeIdDict[e].x,v.nodeIdDict[e].y,v.nodeIdDict[e].z);n.add(s);E[i][e]=s}else{d[0].material=a[t];d[0].tag=r;d[0].position.set(v.nodeIdDict[e].x,v.nodeIdDict[e].y,v.nodeIdDict[e].z);n.add(d[0]);E[i][e]=d[0];d.splice(0,1)}}else if(r!=E[i][e].tag){E[i][e].material=a[t];E[i][e].tag=r}}}function W(e,t,i,a){if(i[t]=="blank"){if(f[e]!=undefined){m.push(f[e]);a.remove(f[e]);delete f[e]}}else{let n=t;if(f[e]==undefined){if(m.length<=0){let r=L.nodeEvent.protection({topColor:i[t],bottomColor:0});r.scale.set(1.5,1.5,1.5);r.rotation.y=Math.PI/2;r.tag=n;r.position.set(v.nodeIdDict[e].x,v.nodeIdDict[e].y,v.nodeIdDict[e].z);a.add(r);f[e]=r}else{m[0].material.uniforms.topColor.value=new THREE.Color(i[t]);m[0].tag=n;m[0].position.set(v.nodeIdDict[e].x,v.nodeIdDict[e].y,v.nodeIdDict[e].z);a.add(m[0]);f[e]=m[0];m.splice(0,1)}}else if(n!=f[e].tag){f[e].material.uniforms.topColor.value=new THREE.Color(i[t]);f[e].tag=n}}}var J=new Set;var V=new Map;var K=new Map;var Q=new Map;var ee;function te(e){new TWEEN.Tween({percent:0}).to({percent:1},5e3).easing(TWEEN.Easing.Linear.None).onComplete(function(){if(p[e]!=undefined){H.remove(p[e]);g.push(p[e]);delete p[e]}}).start()}function ie(e,t,i,a,n,r){for(var s=0;s<e[i].length;s++){if(e[e[i][s]]==undefined){if(r!=undefined){K.get(r).now++;if(K.get(r).leafnum!=K.get(r).now){var o=L.lineEvent[a]([i,e[i][s]],n);t.push(o)}else{var o=L.lineEvent[a]([i,e[i][s]],n,function(e){setTimeout(function(){for(var t=0;t<V.get(e).length;t++){V.get(e)[t].remove()}H.remove(Q.get(e))},1e3)}(r));t.push(o)}let l=e[i][s];var d;let c=n.material.color;if(p[l]==undefined){if(g.length<=0){var d=new THREE.Sprite(new THREE.SpriteMaterial({map:C("rgba(255, 255, 255, 1)","rgba(255, 255, 255, 0.5)"),color:n.material.color}));d.position.set(v.nodeIdDict[l].x,v.nodeIdDict[l].y,v.nodeIdDict[l].z);H.add(d);p[l]=d}else{d=g[0];g[0].position.set(v.nodeIdDict[l].x,v.nodeIdDict[l].y,v.nodeIdDict[l].z);g[0].material.color=c;H.add(g[0]);p[l]=g[0];g.splice(0,1)}}else{p[l].material.color=n.material.color}te(l)}else{var o=L.lineEvent[a]([i,e[i][s]],n);t.push(o)}}else{ae(e,t,s,i,a,n,r)}}}function ae(e,t,i,a,n,r,s){var o=e[a][i];var d=L.lineEvent[n]([a,e[a][i]],r,function i(){let a=e;let d=t;let l=o;let c=s;ie(a,d,l,n,r,c)});t.push(d)}function ne(e,t){if(e[t]!=undefined){if(J.has(e[t].eventid)){t++;ne(e,t)}else{Te(e,t)}}}let re=new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide});let se=new THREE.MeshBasicMaterial({color:15512064,side:THREE.DoubleSide});let oe=new THREE.MeshBasicMaterial({color:4491422,side:THREE.DoubleSide});let de=new THREE.SpriteMaterial({map:v.texturesLibrary.loadPicture(Space3D_Textures.texturesLibs.login),color:4491422});let le=new THREE.SpriteMaterial({map:v.texturesLibrary.loadPicture(Space3D_Textures.texturesLibs.points),color:15129466,depthTest:false,blending:THREE.AdditiveBlending});let ce=new THREE.MeshBasicMaterial({color:16711680,side:THREE.DoubleSide});let ue=new THREE.SpriteMaterial({map:v.texturesLibrary.loadPicture(Space3D_Textures.texturesLibs.virus),color:16711680});let pe=new THREE.MeshBasicMaterial({color:14701311,side:THREE.DoubleSide});let fe=new THREE.SpriteMaterial({map:v.texturesLibrary.loadPicture(Space3D_Textures.texturesLibs.info),color:14701311});let be=new THREE.MeshBasicMaterial({color:310764,side:THREE.DoubleSide});let ge=new THREE.SpriteMaterial({map:v.texturesLibrary.loadPicture(Space3D_Textures.texturesLibs.mail),color:310764});let me=new THREE.MeshBasicMaterial({color:10268425,side:THREE.DoubleSide});let Ee=new THREE.MeshBasicMaterial({color:16711680,side:THREE.DoubleSide});let xe=new THREE.SpriteMaterial({map:v.texturesLibrary.loadPicture(Space3D_Textures.texturesLibs.Eternalblue)});let he=new THREE.SpriteMaterial({map:v.texturesLibrary.loadPicture(Space3D_Textures.texturesLibs.backdoor),color:16711680});let ve=new THREE.SpriteMaterial({map:v.texturesLibrary.loadPicture(Space3D_Textures.texturesLibs.service),color:16711680});let De=new THREE.SpriteMaterial({map:v.texturesLibrary.loadPicture(Space3D_Textures.texturesLibs.Gh0st),color:16711680});function Te(e,t){for(let e in f){m.push(f[e]);H.remove(f[e]);delete f[e]}$("div.wholeProcess > div").removeClass("highlight");$("."+e[t].type).addClass("highlight");$("."+e[t].type).css("filter","brightness(1)");if(e[t].nodestate!=undefined){let i=e[t].nodestate;for(let a=0;a<i.length;a++){if(i[a][x.trojanType]!=undefined){let n=i[a][x.id];let r=i[a][x.trojanType];if(v.nodeIdDict[n]!=undefined){W(n,r,B,H)}else{console.log("点数据eventid: "+e[t].eventid+"有误："+n+"在拓扑结构中不存在")}}}}else{let i={};let a=e[t].startid;let n=[...new Set(e[t].endid)];let r=0;J.add(e[t].eventid);for(let e=0;e<n.length;e++){if(v.nodeIdDict[a]!=undefined&&v.nodeIdDict[n[e]]!=undefined&&a!=n[e]){let t=q.pathCompletion(a,n[e]);if(t!=false){r++;for(let e=0;e<t.length-1;e++){if(i[t[e]]){let a=i[t[e]];if(a.indexOf(t[e+1])==-1){i[t[e]].push(t[e+1])}}else{i[t[e]]=[t[e+1]]}}}}}if(i[e[t].startid]){V.set(e[t].eventid,new Array);let a=new THREE.Object3D;H.add(a);Q.set(e[t].eventid,a);let n=e[t].eventid;switch(e[t].type){case"IntranetScan":K.set(n,{leafnum:r,now:0});let s=V.get(e[t].eventid);ie(i,s,e[t].startid,"particlesLine",{material:le,parentobj:a,speed:speedConfig.IntranetScan,size:100,segmentDistance:100,repeat:3},n);break;case"SqlAttack":let o=V.get(e[t].eventid);K.set(n,{leafnum:r,now:0});console.log(speedConfig);ie(i,o,e[t].startid,"tubeLine",{material:se,parentobj:a,radius:15,speed:speedConfig.SqlAttack},n);break;case"Login":K.set(n,{leafnum:r,now:0});let d=V.get(e[t].eventid);ie(i,d,e[t].startid,"tubeLine",{material:oe,parentobj:a,radius:15,speed:speedConfig.Login},n);ie(i,d,e[t].startid,"transfer",{material:de,parentobj:a,speed:speedConfig.Login,scale:150});break;case"office":K.set(n,{leafnum:r,now:0});let l=V.get(e[t].eventid);ie(i,l,e[t].startid,"tubeLine",{material:ce,parentobj:a,radius:15,speed:speedConfig.office},n);ie(i,l,e[t].startid,"transfer",{material:ue,parentobj:a,speed:speedConfig.office,scale:150});break;case"ReturnFile":K.set(n,{leafnum:r,now:0});let c=V.get(e[t].eventid);ie(i,c,e[t].startid,"tubeLine",{material:pe,parentobj:a,radius:15,speed:speedConfig.ReturnFile},n);ie(i,c,e[t].startid,"transfer",{material:fe,parentobj:H,speed:speedConfig.ReturnFile,scale:150});break;case"FileSteal":K.set(n,{leafnum:r,now:0});let u=V.get(e[t].eventid);ie(i,u,e[t].startid,"tubeLine",{material:pe,parentobj:a,radius:15,speed:speedConfig.FileSteal},n);ie(i,u,e[t].startid,"transfer",{material:fe,parentobj:H,speed:speedConfig.FileSteal,scale:150});break;case"SuspiciousEmail":K.set(n,{leafnum:r,now:0});let p=V.get(e[t].eventid);ie(i,p,e[t].startid,"tubeLine",{material:be,parentobj:a,radius:15,speed:speedConfig.SuspiciousEmail},n);ie(i,p,e[t].startid,"transfer",{material:ge,parentobj:a,speed:speedConfig.SuspiciousEmail,scale:150});break;case"backdoor":K.set(n,{leafnum:r,now:0});let f=V.get(e[t].eventid);ie(i,f,e[t].startid,"tubeLine",{material:Ee,parentobj:a,radius:15,speed:speedConfig.backdoor},n);ie(i,f,e[t].startid,"transfer",{material:he,parentobj:a,speed:speedConfig.backdoor,scale:150});break;case"service":K.set(n,{leafnum:r,now:0});let b=V.get(e[t].eventid);ie(i,b,e[t].startid,"tubeLine",{material:Ee,parentobj:a,radius:15,speed:speedConfig.service},n);ie(i,b,e[t].startid,"transfer",{material:ve,parentobj:a,speed:speedConfig.service,scale:150});break;case"Gh0st":K.set(n,{leafnum:r,now:0});let g=V.get(e[t].eventid);ie(i,g,e[t].startid,"tubeLine",{material:Ee,parentobj:a,radius:15,speed:speedConfig.Gh0st},n);ie(i,g,e[t].startid,"transfer",{material:De,parentobj:a,speed:speedConfig.Gh0st,scale:150});break;case"C2Connect":K.set(n,{leafnum:r,now:0});let m=V.get(e[t].eventid);ie(i,m,e[t].startid,"tubeLine",{material:me,parentobj:a,radius:15,speed:speedConfig.C2Connect},n);break;case"EternalblueExploit":K.set(n,{leafnum:r,now:0});let E=V.get(e[t].eventid);ie(i,E,e[t].startid,"tubeLine",{material:Ee,parentobj:a,radius:15,speed:speedConfig.EternalblueExploit},n);ie(i,E,e[t].startid,"transfer",{material:xe,parentobj:a,speed:speedConfig.Gh0st,scale:150});break;default:console.log(e[t].type+"事件类型未定义");let x=V.get(e[t].eventid);K.set(n,{leafnum:r,now:0});ie(i,x,e[t].startid,"tubeLine",{material:re,parentobj:a,radius:15,speed:11},n);break}}else{console.log("线数据eventid: "+e[t].eventid+"有误")}}t++;if(e[t]!=undefined&&!J.has(e[t].eventid)){setTimeout(function(){Te(e,t)},a)}if(e[t]==undefined){setTimeout(function(){$("div.wholeProcess > div").css("filter","brightness(0.5)");J.clear();Te(e,0)},n.circularDelay)}}let Se=10;let ye;let we;function Ie(){$.getJSON(n.refresh,function(e){if(e.status=="success"){let t=e.data.events;if(t.length>0){if(t.length!=Se||t[0].eventid!=ye){if(J.size>1e3){J.clear()}Se=t.length;ye=t[0].eventid;ne(t,0)}}}})}setTimeout(function(){Ie()},100);O.replayHandler=function(e,t,i){console.info(e,t,i)};return O}return n});